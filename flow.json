[{"id":"91f789ec.a4f17","type":"tab","label":"Playground, tests","disabled":false,"info":""},{"id":"f7a0cac1.5f5af","type":"tab","label":"MQTT","disabled":false,"info":""},{"id":"98b0effc.65096","type":"tab","label":"Sensors","disabled":false,"info":""},{"id":"f898b011.8cb44","type":"tab","label":"LCD","disabled":false,"info":""},{"id":"c16ac57b.fa21f","type":"tab","label":"Camera","disabled":false,"info":""},{"id":"46da62d0.dcba5c","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"plantdb","name":"plantdb","usetls":false,"tls":""},{"id":"42ca863f.50d128","type":"mqtt-broker","z":"","name":"QNAP","broker":"10.0.10.30","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"809d3c6.94b7cc","type":"rpi-gpio out","z":"91f789ec.a4f17","name":"","pin":"11","set":true,"level":"0","freq":"","out":"out","x":480,"y":80,"wires":[]},{"id":"5a7262a1.c43794","type":"inject","z":"91f789ec.a4f17","name":"","topic":"","payload":"true","payloadType":"bool","repeat":"3","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":80,"wires":[["e7cdb55c.ac56b8"]]},{"id":"e7cdb55c.ac56b8","type":"trigger","z":"91f789ec.a4f17","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"50","extend":false,"units":"ms","reset":"","bytopic":"all","name":"","x":290,"y":80,"wires":[["809d3c6.94b7cc"]]},{"id":"d190eb89.5eac9","type":"rpi-gpio out","z":"91f789ec.a4f17","name":"Relay","pin":"13","set":true,"level":"0","freq":"","out":"out","x":490,"y":160,"wires":[]},{"id":"85ecb1b.fa4f75","type":"inject","z":"91f789ec.a4f17","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":160,"wires":[["b10d0d1d.eee0d"]]},{"id":"b10d0d1d.eee0d","type":"trigger","z":"91f789ec.a4f17","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"1","extend":false,"units":"s","reset":"","bytopic":"all","name":"","x":300,"y":160,"wires":[["d190eb89.5eac9"]]},{"id":"df4c01ed.fb6238","type":"Bme280","z":"98b0effc.65096","name":"BME280","bus":"1","address":"0x76","topic":"bme280","extra":false,"x":280,"y":200,"wires":[["89a1f0fb.062d28","20a9c6bd.64feb2","69872bb9.1fa6bc","2eb5ceea.1a8862"]]},{"id":"2483a999.6ff35e","type":"inject","z":"98b0effc.65096","name":"","topic":"","payload":"true","payloadType":"bool","repeat":"60","crontab":"","once":true,"onceDelay":"1","x":110,"y":200,"wires":[["df4c01ed.fb6238","6c4e3992.357aa","76bc5368.817a14"]]},{"id":"9f258992.a47538","type":"influxdb out","z":"98b0effc.65096","influxdb":"46da62d0.dcba5c","name":"temperature","measurement":"temperature","precision":"","retentionPolicy":"","x":870,"y":160,"wires":[]},{"id":"89a1f0fb.062d28","type":"function","z":"98b0effc.65096","name":"temperature","func":"newMsg = {};\nnewMsg.payload = msg.payload.temperature_C;\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":590,"y":160,"wires":[["9f258992.a47538"]]},{"id":"20a9c6bd.64feb2","type":"function","z":"98b0effc.65096","name":"humidity","func":"newMsg = {};\nnewMsg.payload = msg.payload.humidity;\nreturn newMsg;","outputs":1,"noerr":0,"x":580,"y":200,"wires":[["a92609b8.0b74d"]]},{"id":"69872bb9.1fa6bc","type":"function","z":"98b0effc.65096","name":"pressure","func":"newMsg = {};\nnewMsg.payload = msg.payload.pressure_hPa;\nreturn newMsg;","outputs":1,"noerr":0,"x":580,"y":240,"wires":[["a5ba99fb.0b966"]]},{"id":"a92609b8.0b74d","type":"influxdb out","z":"98b0effc.65096","influxdb":"46da62d0.dcba5c","name":"humidity","measurement":"humidity","precision":"","retentionPolicy":"","x":860,"y":200,"wires":[]},{"id":"a5ba99fb.0b966","type":"influxdb out","z":"98b0effc.65096","influxdb":"46da62d0.dcba5c","name":"pressure","measurement":"pressure","precision":"","retentionPolicy":"","x":860,"y":240,"wires":[]},{"id":"f9fa84a1.d8683","type":"LCD-I2C","z":"f898b011.8cb44","name":"4x20 LCD","variant":"PCF8574","size":"20x4","x":700,"y":160,"wires":[]},{"id":"8204dda.5c169a","type":"function","z":"f898b011.8cb44","name":"combine received msgs into one","func":"context.data = context.data || {};\n\nswitch (msg.topic) {\n    case \"bme280\":\n        context.data.temperature = msg.payload.temperature_C;\n        context.data.humidity = msg.payload.humidity;\n        context.data.preassure = msg.payload.pressure_hPa;\n        msg = null;\n        break;\n        \n    case \"up\":\n        context.data.uptime = msg.payload;\n        msg = null;\n        break;\n}\n\nif (context.data.temperature != null &&\n    context.data.humidity != null &&\n    context.data.preassure != null &&\n    context.data.uptime != null) {\n        newMsg = {};\n        var temp = Number(context.data.temperature).toFixed(2);\n        var humi = Number(context.data.humidity).toFixed(2);\n        var press = Number(context.data.preassure).toFixed(1);\n\n        newMsg.payload =\n        [{\n            \"clear\": true,\n            \"text\": \"temp \"+ temp,\n            \"aligment\": \"left\"\n            },\n            {\n            \"clear\": true,\n            \"text\": \"hum  \"+ humi,\n            \"aligment\": \"left\"\n            },\n            {\n            \"clear\": true,\n             \"text\": \"pres \"+ press,\n             \"aligment\": \"left\"\n            },\n            {\n            \"clear\": true,\n            \"text\": \"up  \"+ context.data.uptime,\n            \"aligment\": \"left\"\n            }\n        ]\n        return newMsg;\n}\n\n","outputs":1,"noerr":0,"x":450,"y":160,"wires":[["f9fa84a1.d8683"]]},{"id":"6ab4dbc2.100f9c","type":"link in","z":"f898b011.8cb44","name":"to-display-on-LCD","links":["aa4365c9.761a18","dd12e0ac.f6805"],"x":255,"y":160,"wires":[["8204dda.5c169a"]]},{"id":"aa4365c9.761a18","type":"link out","z":"98b0effc.65096","name":"bme280-readings","links":["6ab4dbc2.100f9c"],"x":815,"y":120,"wires":[]},{"id":"84a16c59.7d012","type":"Uptime","z":"91f789ec.a4f17","name":"","x":260,"y":240,"wires":[["f9386a3f.1218a"]]},{"id":"4a94984b.51f1b8","type":"inject","z":"91f789ec.a4f17","name":"","topic":"","payload":"true","payloadType":"bool","repeat":"60","crontab":"","once":true,"onceDelay":"0.5","x":110,"y":240,"wires":[["84a16c59.7d012"]]},{"id":"f9386a3f.1218a","type":"function","z":"91f789ec.a4f17","name":"secs2human","func":"function secondsToString(seconds)\n{\nvar numdays = Math.floor((seconds % 31536000) / 86400); \nvar numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);\nvar numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);\nvar numseconds = (((seconds % 31536000) % 86400) % 3600) % 60;\nreturn (numdays + \"d \" + numhours + \"h \" + numminutes + \"m\");\n\n}\nmsg.payload =secondsToString(msg.payload.uptime)\nmsg.topic=\"up\";\nreturn msg","outputs":1,"noerr":0,"x":430,"y":240,"wires":[["dd12e0ac.f6805"]]},{"id":"dd12e0ac.f6805","type":"link out","z":"91f789ec.a4f17","name":"uptime","links":["6ab4dbc2.100f9c"],"x":555,"y":240,"wires":[]},{"id":"2eb5ceea.1a8862","type":"function","z":"98b0effc.65096","name":"topic bme280","func":"msg.topic=\"bme280\";\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":120,"wires":[["aa4365c9.761a18"]]},{"id":"db0c6d5d.5f565","type":"comment","z":"91f789ec.a4f17","name":"TODO list","info":"add calendar to turn on off lcd background or a button perhaps or PIR","x":800,"y":80,"wires":[]},{"id":"e81b166a.f93e98","type":"mqtt in","z":"f7a0cac1.5f5af","name":"","topic":"garden/weather/sensor/temperature","qos":"2","datatype":"auto","broker":"42ca863f.50d128","x":220,"y":100,"wires":[["636e86c0.d2c038"]]},{"id":"636e86c0.d2c038","type":"influxdb out","z":"f7a0cac1.5f5af","influxdb":"46da62d0.dcba5c","name":"outdoor temperature","measurement":"temeprature_outdoor","precision":"","retentionPolicy":"","x":530,"y":100,"wires":[]},{"id":"b0f5c114.a4bbc8","type":"mqtt in","z":"f7a0cac1.5f5af","name":"","topic":"garden/weather/sensor/humidity","qos":"2","datatype":"auto","broker":"42ca863f.50d128","x":210,"y":180,"wires":[["7f917eb4.0340c"]]},{"id":"7f917eb4.0340c","type":"influxdb out","z":"f7a0cac1.5f5af","influxdb":"46da62d0.dcba5c","name":"outdoor humidity","measurement":"humidity_outdoor","precision":"","retentionPolicy":"","x":520,"y":180,"wires":[]},{"id":"76bc5368.817a14","type":"pythonshell in","z":"98b0effc.65096","name":"read lx","pyfile":"/home/pi/.node-red/projects/plant-monitor/read_tls2561.py","virtualenv":"","continuous":false,"stdInData":false,"x":290,"y":400,"wires":[["7a858685.7a072"]]},{"id":"7a858685.7a072","type":"yaml","z":"98b0effc.65096","property":"payload","name":"","x":430,"y":400,"wires":[["a35d5973.426f78"]]},{"id":"cff98706.3b94","type":"switch","z":"98b0effc.65096","name":"","property":"topic","propertyType":"msg","rules":[{"t":"cont","v":"Full","vt":"str"},{"t":"cont","v":"IR","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":400,"wires":[["bc1e44ff.c0223"],["979a9938.3e7a"]]},{"id":"a35d5973.426f78","type":"split","z":"98b0effc.65096","name":"","splt":",","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":570,"y":400,"wires":[["cff98706.3b94"]]},{"id":"bc1e44ff.c0223","type":"influxdb out","z":"98b0effc.65096","influxdb":"46da62d0.dcba5c","name":"light-full","measurement":"light-full","precision":"","retentionPolicy":"","x":860,"y":360,"wires":[]},{"id":"979a9938.3e7a","type":"influxdb out","z":"98b0effc.65096","influxdb":"46da62d0.dcba5c","name":"light-ir","measurement":"light-ir","precision":"","retentionPolicy":"","x":850,"y":420,"wires":[]},{"id":"6c4e3992.357aa","type":"ads1x15-raspi","z":"98b0effc.65096","property":"payload","name":"AD converter","chip":"IC_ADS1015","i2c_address":"ADDRESS_0x48","channel":"CHANNEL_0","samplesPerSecond0":"SPS_920","samplesPerSecond1":"SPS_128","progGainAmp":"PGA_4_096V","x":290,"y":540,"wires":[["df1bb79d.d72ab8"]]},{"id":"df1bb79d.d72ab8","type":"change","z":"98b0effc.65096","name":"Extract value","rules":[{"t":"set","p":"payload","pt":"msg","to":"*.*","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":540,"wires":[["151b417c.e58407"]]},{"id":"76a21567.701b9c","type":"influxdb out","z":"98b0effc.65096","influxdb":"46da62d0.dcba5c","name":"moisture","measurement":"moisture ","precision":"","retentionPolicy":"","x":860,"y":540,"wires":[]},{"id":"6465c5dc.369c24","type":"camerapi-takephoto","z":"c16ac57b.fa21f","filemode":"1","filename":"{{msg.payload.filename}}","filedefpath":"0","filepath":"/home/pi/pictures/","fileformat":"jpeg","resolution":"1","rotation":"0","fliph":"0","flipv":"0","brightness":"50","contrast":"0","sharpness":"0","quality":"80","imageeffect":"none","exposuremode":"auto","iso":"0","agcwait":"1.0","led":"1","awb":"auto","name":"take photo","x":810,"y":120,"wires":[["530307bb.789ef8"]]},{"id":"151b417c.e58407","type":"function","z":"98b0effc.65096","name":"reformat","func":"msg.payload = JSON.parse(Number(msg.payload).toFixed(2));\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":540,"wires":[["76a21567.701b9c"]]},{"id":"dab8342d.e3b3a8","type":"comment","z":"f7a0cac1.5f5af","name":"External sensors values","info":"","x":180,"y":40,"wires":[]},{"id":"5068057d.fed9ec","type":"comment","z":"f898b011.8cb44","name":"","info":"","x":480,"y":80,"wires":[]},{"id":"d2639062.f8449","type":"function","z":"c16ac57b.fa21f","name":"format image name string","func":"var date;\ndate = new Date();\ndate = (date.getFullYear() + '-' + ('00' + (date.getMonth()+1)).slice(-2) + '-' + ('00' + date.getDate()).slice(-2) + 'T' + ('00' + date.getHours()).slice(-2) + ':' + ('00' + date.getMinutes()).slice(-2) + ':' + ('00' + date.getSeconds()).slice(-2));\n\nmsg.filename = \"plant_picture_\" + date + \".jpg\";\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":120,"wires":[["6465c5dc.369c24"]]},{"id":"530307bb.789ef8","type":"influxdb out","z":"c16ac57b.fa21f","influxdb":"46da62d0.dcba5c","name":"camera","measurement":"camera ","precision":"","retentionPolicy":"","x":980,"y":120,"wires":[]},{"id":"b0edd76c.23467","type":"rpi-srf","z":"c16ac57b.fa21f","name":"SR04","topic":"SRF","pulse":"0.5","pins":"40,38","x":70,"y":120,"wires":[["61f5e291.6167b4","b4675d35.d9d46"]]},{"id":"61f5e291.6167b4","type":"function","z":"c16ac57b.fa21f","name":"<200","func":"msg.payload = JSON.parse(Number(msg.payload));\nif (msg.payload < 200){\n    return msg;\n}\n","outputs":1,"noerr":0,"x":210,"y":120,"wires":[["4902236a.13ed2c"]]},{"id":"4902236a.13ed2c","type":"delay","z":"c16ac57b.fa21f","name":"1msg/1min","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":370,"y":120,"wires":[["d2639062.f8449"]]},{"id":"b4675d35.d9d46","type":"debug","z":"c16ac57b.fa21f","name":"SR","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":210,"y":60,"wires":[]}]